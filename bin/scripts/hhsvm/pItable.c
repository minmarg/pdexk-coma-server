#include <stdio.h>
#include <string.h>
#include <math.h>

int main( int argc, char *argv[] )
{
    const char*   pname = "charges";
    char          output[1024];

    const char*   basicres = "KRH";
    const char*   acidicres = "xxxDECY";
    const char*   res = "KRHDECY";
    const int     NOBASICRES = 3;
    const int     NOACIDICRES = 4;
    const int     NORES = NOBASICRES + NOACIDICRES;

    const double  basicpKs[] = { 9.8, 12.5, 6.08 };
    const double  acidicpKs[] = { 4.07, 4.45, 8.28, 9.84 };
    double        pKs[NORES];

    const double  pHstep = 0.01;
    const double  pHmin = 0.0;
    const double  pHmax = 14.0;

    double        pH, pI;
    int           n;

    sprintf( output, "%s.pm", pname );
    FILE*         fp = fopen( output, "w");

    if( fp == NULL ) {
        fprintf( stderr, "ERROR: Failed to open file for writing: %s\n", output );
        return 1;
    }

    for( n = 0; n < NORES; n++) {
        if( n < NOBASICRES )
            pKs[n] = basicpKs[n];
        else
            pKs[n] = acidicpKs[n - NOBASICRES];
    }

    fprintf( fp, "package %s;\n", pname );
    fprintf( fp, "##- $$ generated by %s $$\n\n", argv[0]);
    fprintf( fp, "use strict;\n\n");

    fprintf( fp, "BEGIN {\n");
    fprintf( fp, "    ##%15c", 32 );
        for( n = 0; n < NORES; n++)
            fprintf( fp, "%12c    ", res[n]);
    fprintf( fp, "\n");

    fprintf( fp, "    my  @CHARGES = (\n");
    for( pH = pHmin; pH <= pHmax; pH += pHstep ) {
        fprintf( fp, "%20c[", 32 );
        for( n = 0; n < NORES; n++) {
            if( n < NOBASICRES )
                pI = 1.0 / ( 1.0 + pow( 10.0, pH - pKs[n] ));
            else
                pI = -1.0 / ( 1.0 + pow( 10.0, pKs[n] - pH ));
            if( n )
                fprintf( fp, ",");
            fprintf( fp, "%15.12f", pI );
        }
        fprintf( fp, "]");
        if( pH + pHstep <= pHmax )
            fprintf( fp, ",");
        fprintf( fp, " ##pH = %f\n", pH );
    }
    fprintf( fp, "        );\n");
    fprintf( fp, "    sub GetCHARGES  { return \\@CHARGES; }\n");
    fprintf( fp, "}\n\n");

    fprintf( fp, "sub new {\n");
    fprintf( fp, "    my $that  = shift;\n");
    fprintf( fp, "    my $class = ref( $that ) || $that;\n");
    fprintf( fp, "    my $self;\n\n");
    fprintf( fp, "    $self->{CHARGES} = GetCHARGES();   ## charges of residues\n\n");
    fprintf( fp, "    while( scalar( @_ )) {\n");
    fprintf( fp, "        $self->{uc( $_[0] )} = $_[1];\n");
    fprintf( fp, "        shift, shift;\n");
    fprintf( fp, "    }\n");
    fprintf( fp, "    return bless  $self, $class;\n");
    fprintf( fp, "}\n\n");
    fprintf( fp, "sub Charges { my $self = shift; if (@_) { $self->{CHARGES} = shift } return $self->{CHARGES}; }\n\n");
    fprintf( fp, "1;\n");
    fclose( fp );
    return 0;
}

